<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced WebRTC Call</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        video { width: 45%; border: 2px solid black; margin: 5px; }
        #controls, #chat-section { margin: 10px; }
    </style>
</head>
<body>
    <h2>WebRTC Video Call & Chat</h2>
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
    
    <div id="controls">
        <button onclick="startCall()">Start Call</button>
        <button onclick="generateOffer()">Generate Offer</button>
        <button onclick="connect()">Connect</button>
        <button onclick="toggleAudio()">Toggle Audio</button>
        <button onclick="toggleVideo()">Toggle Video</button>
    </div>
    
    <h3>SDP Exchange</h3>
    <textarea id="offer" placeholder="Paste Offer SDP here" rows="6" cols="50"></textarea>
    <button onclick="copyOffer()">Copy Offer</button>
    
    <textarea id="answer" placeholder="Paste Answer SDP here" rows="6" cols="50"></textarea>
    <button onclick="copyAnswer()">Copy Answer</button>
    
    <h3>Text Chat</h3>
    <input type="text" id="message" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <div id="chat-section"></div>
    
    <script>
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let localStream, remoteStream, peerConnection, dataChannel;
        
        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");
        const offerInput = document.getElementById("offer");
        const answerInput = document.getElementById("answer");
        const chatSection = document.getElementById("chat-section");
        const messageInput = document.getElementById("message");

        async function startCall() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            dataChannel = peerConnection.createDataChannel("chat");
            setupDataChannel(dataChannel);
            peerConnection.ontrack = (event) => remoteVideo.srcObject = event.streams[0];
            peerConnection.onicecandidate = (event) => event.candidate && console.log("ICE Candidate: ", event.candidate);
        }

        async function generateOffer() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            offerInput.value = JSON.stringify(offer);
        }

        async function connect() {
            const remoteOffer = JSON.parse(offerInput.value);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteOffer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            answerInput.value = JSON.stringify(answer);
            peerConnection.ondatachannel = (event) => setupDataChannel(event.channel);
        }

        function copyOffer() { navigator.clipboard.writeText(offerInput.value); }
        function copyAnswer() { navigator.clipboard.writeText(answerInput.value); }

        function setupDataChannel(channel) {
            channel.onmessage = (event) => chatSection.innerHTML += `<p>Peer: ${event.data}</p>`;
            channel.onopen = () => console.log("Data channel opened");
            window.sendMessage = () => {
                const message = messageInput.value;
                channel.send(message);
                chatSection.innerHTML += `<p>You: ${message}</p>`;
            };
        }

        function toggleAudio() { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
        function toggleVideo() { localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; }
    </script>
</body>
</html>
